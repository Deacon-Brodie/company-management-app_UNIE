name: Veracode SAST + SCA

on: [push, pull_request]

jobs:
  veracode_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v3

      - name: Instalar Veracode CLI
        run: |
          curl -fsS https://tools.veracode.com/veracode-cli/install | sh
          ./veracode version

      - name: Ejecutar an√°lisis SAST
        env:
          VERACODE_API_KEY_ID: vera01ei-9a1cc4a568419a2a9eb1e781e5396c61
          VERACODE_API_KEY_SECRET: vera01es-dcc90db27edcc71aaf5403176191e0a9fd557aa6f6529a08921a21ca531b351695649c38bb8ad1d2d682fcc0166fec33d4d22a50ae021ff118299f54aad85e0c
        run: |
          echo $VERACODE_API_KEY_ID
          ./veracode scan --source . --type directory --format json --output sast-result.json
          echo "üìÑ Resultado SAST:"
          cat sast-result.json
          if jq -e '.findings[] | select(.severity=="CRITICAL")' sast-result.json; then
            echo "‚ùå Vulnerabilidades CR√çTICAS detectadas en SAST"
            exit 1
          else
            echo "‚úÖ SAST limpio de vulnerabilidades cr√≠ticas"
          fi


      - name: Ejecutar an√°lisis SCA (dependencias)
        env:
          VERACODE_API_KEY_ID: ${{ secrets.VERACODE_API_ID }}
          VERACODE_API_KEY_SECRET: ${{ secrets.VERACODE_API_KEY }}
        run: |
          ./veracode sbom --source . --format cyclonedx-json --output sbom.json
          ./veracode scan --type sca --source sbom.json --format json --output sca-result.json
          echo "üìÑ Resultado SCA:"
          cat sca-result.json
          if jq -e '.findings[] | select(.severity=="CRITICAL")' sca-result.json; then
            echo "‚ùå Vulnerabilidades CR√çTICAS detectadas en SCA"
            exit 1
          else
            echo "‚úÖ SCA limpio de vulnerabilidades cr√≠ticas"
          fi
